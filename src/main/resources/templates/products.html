<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>WMS - Products</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #007bff; color: white; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; border: none; }
        .btn-danger { background: #dc3545; color: white; border: none; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 50%; }
        input, select { width: 100%; padding: 8px; margin: 8px 0; box-sizing: border-box; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        #logout { float: right; }
    </style>
</head>
<body>
<h1>Product Management</h1>
<button id="logout" class="btn-danger">Logout</button>
<button id="createProductBtn" class="btn-primary">Create Product</button>
<input type="text" id="searchInput" placeholder="Search products..." style="width: 300px; margin: 10px 0;" />

<table id="productsTable">
    <thead>
    <tr>
        <th>ID</th>
        <th>SKU</th>
        <th>Name</th>
        <th>Category</th>
        <th>Unit Price</th>
        <th>Min Stock</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="productsBody"></tbody>
</table>

<!-- Create/Edit Product Modal -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2 id="modalTitle">Create Product</h2>
        <form id="productForm">
            <input type="hidden" id="productId" />
            <input type="text" id="sku" placeholder="SKU" required />
            <input type="text" id="barcode" placeholder="Barcode" />
            <input type="text" id="name" placeholder="Product Name" required />
            <textarea id="description" placeholder="Description" rows="3"></textarea>
            <input type="text" id="unit" placeholder="Unit (e.g., PCS, KG)" required />
            <input type="number" id="unitPrice" placeholder="Unit Price" step="0.01" required />
            <input type="number" id="minStockLevel" placeholder="Min Stock Level" required />
            <input type="text" id="category" placeholder="Category" />
            <button type="submit" class="btn-primary">Save</button>
        </form>
    </div>
</div>

<script>
    const token = localStorage.getItem('token');
    if (!token) {
        window.location.href = '/login';
    }

    const headers = {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
    };

    // Logout
    document.getElementById('logout').addEventListener('click', () => {
        localStorage.clear();
        window.location.href = '/login';
    });

    // Load products
    async function loadProducts(search = '') {
        try {
            const url = search ? `/api/products?search=${search}` : '/api/products';
            const response = await fetch(url, { headers });
            const data = await response.json();
            console.log('API Response:', data);
            const tbody = document.getElementById('productsBody');
            tbody.innerHTML = '';

            const products = data.data.content || data.data;
            console.log('Products array:', products);
            products.forEach(product => {
                const row = `
                        <tr>
                            <td>${product.id}</td>
                            <td>${product.sku}</td>
                            <td>${product.name}</td>
                            <td>${product.category || 'N/A'}</td>
                            <td>$${product.unitPrice}</td>
                            <td>${product.minStockLevel}</td>
                            <td>
                                <button class="btn-primary" onclick="editProduct(${product.id})">Edit</button>
                                <button class="btn-danger" onclick="deleteProduct(${product.id})">Delete</button>
                            </td>
                        </tr>
                    `;
                tbody.innerHTML += row;
            });
        } catch (error) {
            console.error('Error loading products:', error);
        }
    }

    // Search
    document.getElementById('searchInput').addEventListener('input', (e) => {
        loadProducts(e.target.value);
    });

    // Modal
    const modal = document.getElementById('productModal');
    const closeBtn = document.getElementsByClassName('close')[0];

    document.getElementById('createProductBtn').addEventListener('click', () => {
        document.getElementById('modalTitle').textContent = 'Create Product';
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        modal.style.display = 'block';
    });

    closeBtn.onclick = () => modal.style.display = 'none';
    window.onclick = (e) => { if (e.target == modal) modal.style.display = 'none'; };

    // Create/Update Product
    document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const productId = document.getElementById('productId').value;
        const productData = {
            sku: document.getElementById('sku').value,
            barcode: document.getElementById('barcode').value,
            name: document.getElementById('name').value,
            description: document.getElementById('description').value,
            unit: document.getElementById('unit').value,
            unitPrice: parseFloat(document.getElementById('unitPrice').value),
            minStockLevel: parseInt(document.getElementById('minStockLevel').value),
            category: document.getElementById('category').value
        };

        try {
            const url = productId ? `/api/products/${productId}` : '/api/products';
            const method = productId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method,
                headers,
                body: JSON.stringify(productData)
            });

            if (response.ok) {
                modal.style.display = 'none';
                loadProducts();
            } else {
                alert('Error saving product');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Network error');
        }
    });

    // Edit Product
    async function editProduct(id) {
        try {
            const response = await fetch(`/api/products/${id}`, { headers });
            const data = await response.json();
            const product = data.data;

            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = product.id;
            document.getElementById('sku').value = product.sku;
            document.getElementById('barcode').value = product.barcode || '';
            document.getElementById('name').value = product.name;
            document.getElementById('description').value = product.description || '';
            document.getElementById('unit').value = product.unit;
            document.getElementById('unitPrice').value = product.unitPrice;
            document.getElementById('minStockLevel').value = product.minStockLevel;
            document.getElementById('category').value = product.category || '';

            modal.style.display = 'block';
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Delete Product
    async function deleteProduct(id) {
        if (!confirm('Are you sure you want to delete this product?')) return;

        try {
            const response = await fetch(`/api/products/${id}`, {
                method: 'DELETE',
                headers
            });

            if (response.ok) {
                loadProducts();
            } else {
                alert('Error deleting product');
            }
        } catch (error) {
            console.error('Error:', error);
        }
    }

    // Initial load
    loadProducts();
</script>
</body>
</html>